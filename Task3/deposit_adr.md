
### <a name="_b7urdng99y53"></a>**Название задачи: Открытие депозитов онлайн**
### <a name="_hjk0fkfyohdk"></a>**Автор: Леонид Смирнов**
### <a name="_uanumrh8zrui"></a>**Дата: 09.07.2025**

### <a name="_3bfxc9a45514"></a>**Функциональные требования**

|  **№**  | **Действующие лица или системы**             | **Use Case**                           | **Описание**                                                                                                                                                                                                                                     |
|:-------:|:---------------------------------------------|:---------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **UC1** | Клиент, сайт                                 | Новый клиент через веб-сайт            | * Клиент попадает на веб-сайт банка. <br/> * Клиент видит там текущие процентные ставки по депозитам. <br/> * Клиент заносит свои данные для открытия депозита                                                                                   |
| **UC2** | Оператор кол-центра, ПО кол-центра, СМС-шлюз | Подтверждение клиента через веб-сайт   | * Оператор кол-центра связывается с клиентом для уточнения его данных и запуска дальнейшего флоу. <br/> * Оператор заносит новую заявку на депозит. <br/> *  Клиенту приходит СМС с подтверждением.                                              |
| **UC3** | Клиент, интернет-банк                        | Заведение депозита через интернет-банк | * Клиент открывает личный кабинет в интернет-банке. <br/> * Клиент выбирает персонализированное предложение для открытия вклада.                                                                                                                 |
| **UC4** | Клиент, менеджер фронт-офиса, АБС, СМС-шлюз  | Подтверждение депозита                 | * Клиент физически объявляется в отделении банка. <br/> * Менеджер проверяет его данные. <br/> Клиенту приходит СМС с кодом подтверждения операции. <br/> Менеджер подтверждает операцию через OTP. <br/> Клиенту приходит СМС с подтверждением. |
| **UC5** | Клиент, интернет-банк, АБС, СМС-шлюз         | Закрытие депозита                      | * Клиент заходит в личный кабинет интернет-банка. <br/> * Портал отображает список активных депозитов. <br/> * Клиент аннулирует депозит. <br/> Клиенту приходит СМС с подтверждением.                                                           |




### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**

| **№** | **Требование**                                                    |
|:-----:|:------------------------------------------------------------------|
|  R1   | Система должна быть доступа 24/7                                  |
|  R2   | Аптайм должен быть не ниже чем 99,9%                              |
|  R4   | Должен быть настроен механизм бэкапов                             |
|  R5   | Масштабирование (горизонтальное для своего, вертикальное для АБС) |
|  P1   | Отклик по операциям должен составлять миллисекунды                |
|  P2   | Системы должны выдерживать рост нагрузки из-за наплыва клиентов   |
|  S1   | Используем преимущественно уже имеющийся стэк                     |
|  +R3  | В качестве шины сообщений используем Apache Kafka                 |
|  +R4  | Используем преимущественно уже имеющиеся технологии               |

### <a name="_qmphm5d6rvi3"></a>**Решение**
Диаграммы:

[Контекст](./context.puml)

[Контейнеры](./container.puml)

Главные архитектурные изменения - это переход на микросервисную архитектуру и трансформация АБС из древнего гомункула в микросервис.
Вкупе они позволят нам обеспечить человеческое масштабирование под нагрузкой, а также исключат необходимость обмена экселями по почте, т.к. АБС 
сможет предоставлять необходимые данные через RBAC.

Этот шаг крайне (самый) объемный и сложный, но его надо реализовать именно на этапе MVP, ибо так и так придется это делать, а после запуска выйдет куда накладнее.
Даже если идея с запуском онлайн-депозитов не взлетит, на руках останется модерновая АБС.

Кеширование и репликация в БД сервисов поможет добиться желанной скорости выполнения операций меньше чем за секунду.

Стэк в данном случае остается прежний. Единственное изменение - это C# 12 и .NET 9 для новой итерации АБС, но это не станет проблемой, т.к. сам банк
написан на .NET Framework. Интернет-банк можно параллельно перевести на тот же .NET 9, изменения придется внести минимальные.

Во вводной не указано, какие системы контейнеризации используются, но все заявленное хорошо играется с Кубером (и Windows-контейнеры в том числе).

В итоге получаем решение, где уже имеющие системы за исключением АБС подвергаются минимальным изменениям (интеграции с кафкой) и могут 
масштабироваться по нескольким ЦОДам.

Конечная система состоит из следующих компонентов:

* Кафка - все системы переходят на асинхронное общение;
* Редис - все АПИ кэшируют в нем все что можно (сайт - ставки, банк - депозиты, кол-центр - заявки, АБС - транзакции, etc);
* Сайт банка (PHP/React) - лэндинг, на который мы заманиваем клиентов выгодными ставками;
* Кол-центр (Java) - система, которая позволяет операторам банка связываться с клиентами и создавать заявки на депозиты от их имени;
* Интернет-банк (.NET) - личный кабинет клиента, где он может оперировать депозитами через браузер;
* АБС (.NET) - основная банковская система, которая будет отвечать за все операции с депозитами, кредитами, ставками и прочими финансовыми операциями.
Все изменения в АБС публикуются в кафку, из кафки же она забирает заявки на открытие депозитов из интернета-банка и кол-центра.

Помимо этого задействованы следующие системы:

* Почтовый сервис. Помечен на внутренний, ибо у финтеха, скорее всего, будет свой Exchange или что-то навроде;
* СМС-шлюз. Железка стоит у оператора, но обслуживается командой банка. Общение с нима идет по REST/SOAP;
* Телеком оператор. Непосредственно то, что занимается рассылкой СМС, поступивших на гейт, случается по SMPP протоколу.

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Если переделка АБС невозможна, то можно навесить на нее CQRS - пусть транзакции пишутся в одну базу и реплицируются в базу на чтение.

Минимально необходимо прикрутить к АБС REST API и веб-интерфейс, а саму базу оставить как есть - у нас жесткое нарушение вменяемости 
из-за того, что другие сервисы ходят в постгрес АБС напрямую. В команде поддержки есть джависты, управятся на раз-два.

Для модернизации всего что можно указан дотнет. Однако, нам ничего не мешает использовать джаву - тут уже дело предпочтений и свободных специалистов.

### <a name="_bjrr7veeh80c"></a>**Недостатки, ограничения, риски**

* Перепиливание старой АБС на новую - очень трудозатратный процесс, так что с таким списком работ на MVP можно не уложиться в бюджет и сроки;
* Мы не меняем стэк БД (Oracle, SQL Server) - в любой момент их могут запретить или попросту нельзя будет продлить лицензию;
* Клиент банка остается монолитом на .NET Framework'e, если его решили не апгрейдить - опять-таки можем лишиться лицензий на Windows,
могут быть проблемы с производительностью из-за устаревшего стэка;
* Вообще _все_ системы остаются монолитами - для запуска продукта этого хватит. В будущем потребуется порезать все помельче.
