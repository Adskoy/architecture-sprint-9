### <a name="_b7urdng99y53"></a>**Название задачи:Передача ставок в кол-центр**
### <a name="_hjk0fkfyohdk"></a>**Автор: Леонид Смирнов**
### <a name="_uanumrh8zrui"></a>**Дата: 09.07.2025**
### <a name="_3bfxc9a45514"></a>**Функциональные требования**

| **№** | **Действующие лица или системы**                                                     | **Use Case**                                   | **Описание**                                                                                                                                                                          |
|:-----:|:-------------------------------------------------------------------------------------|:-----------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  UC1  | * Клиент <br/> * Оператор кол-центра <br/> * ПО кол-центра                           | Запрос информации о ставках                    | * Клиент дозванивается до внутреннего кол-центра <br/> * Оператор запрашивает у системы кол-центра информацию о текущих ставках. <br/> * Оператор предоставляет информацию клиенту.   |
|  UC2  | * Клиент <br/> * Оператор партнерского кол-центра <br/> * ПО партнерского кол-центра | Запрос информации о ставках                    | * Клиент дозванивается до партнерского кол-центра <br/> * Оператор запрашивает у системы кол-центра информацию о текущих ставках. <br/> * Оператор предоставляет информацию клиенту.  |
|  UC3  | * АБС <br/> * Почтовый сервис <br/> ПО партнерского кол-центра                       | Передача информации о текущих ставках партнеру | * По крону запускается джоба, запрашивающая текущие ставки в АБС. <br/> Результат пишется в CSV и отправляется письмом партнеру. <br/> * Партнерское ПО обрабатывает полученный файл. |

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**

| **№** | **Требование**                 |
|:-----:|:-------------------------------|
|   1   | Файловый обмен                 |
|   2   | Без API вызовов                |
|   3   | Данные должны быть актуальными |


### <a name="_qmphm5d6rvi3"></a>**Решение**

[Контекст](./context.puml)

[Контейнеры](./container.puml) (все ненужное для текущего шага удалено)

Решение незамысловатое. По крону или иному триггеру в АБС запускается джоба на вычисление новых ставок по депозитам.

Результат вычислений публикуется в кафку, после чего реплицируется в БД внутреннего кол-центра и пишется в его кэш.
На данном этапе наши операторы могут без проблем предоставлять клиентам актуальную информацию по ставкам.

Дополнительно результат вычислений пишется в JSON/XML/CSV файл и отправляется по почте в партнерский кол-центр.
Что они с ним дальше сделают - загадка, но мы на нее уже не повлияем.

Для запуска продукта потребуются следующие доработки:

**Кафка:**
* Деплой и настройка очередей/топиков;

**АБС:**
* [MVP] Создание REST API для чтения/записи информации в АБС;
* [MVP] Оптимизация и рефакторинг SQL-процедур, по возможности замена их операциями в коде;
* [MVP] Определение ролей для разных категорий пользователей;
* [MVP] Интеграция АБС в Keycloak или напрямую в AD (на случай Windows Server 2019+); 
* [MVP] Реализация механизма вычисления ставок по депозитам;
* [MVP] Интеграция с кафкой;
* [MVP] Написание инструкций;
* [MVP] Интеграция с почтовым сервисом для отправки данных по ставкам в партнерский кол-центр;
* [RELEASE] Сбор фидбэка;
* [RELEASE] Доработка с учетом фидбэка;
* [RELEASE] Актуализация документации;
* [RELEASE] Разделение монолита АБС на микросервисы по продуктам (кредиты, депозиты, документы, etc.);

**Внутренний кол-центр:**
* [MVP] Интеграция с кафкой на получение ставок и публикацию заявок;
* [MVP] Реализация REST API для получения информации о ставках;
* [RELEASE] Сбор фидбэка;
* [RELEASE] Доработка с учетом фидбэка;
* [RELEASE] Актуализация документации;
* [RELEASE] Интеграция функционала CRM в рабочий процесс обслуживания клиентов (за его уже уплачено);

**Сервис уведомлений:**
* [MVP] Разработать универсальную архитектуру для поддержки уведомлений по SMS, email и push каналам.
* [MVP] Создать шаблоны писем по корпоративным гайдлайнам;
* [MVP] Реализовать API для отправки уведомлений по требуемым каналам;

**Сайт:**
* [MVP] Интеграция с кафкой на получение текущих актуальных ставок по депозитам;
* [MVP] Аудит производительности и удобства веб-сайта;
* [RELEASE] Оптимизация и рефакторинг кода и верстки с целью получения минимального time to content;
* [RELEASE] Миграция на SSR (чистый реакт плохо индексируется, медленно грузится и работает);

**Интернет-банк:**
* [MVP] Вынесение функционала отправки СМС;
* [MVP] Миграция кодовой базы на актуальный .NET;
* [MVP] Интеграция с кафкой на публикацию заявок по депозитам и получение актуальных ставок;
* [RELEASE] Сбор фидбэка;
* [RELEASE] Доработка с учетом фидбэка;
* [RELEASE] Актуализация документации;
* [RELEASE] Разделение монолита на микросервисы;
* [RELEASE] Интеграция АБС в Keycloak. Идет позже прочих т.к. здесь внешние пользователи;

**Партнёрский кол-центр:**
* [MVP] Согласование форматов и каналов для обмена данными по текущим ставкам;
* [RELEASE] Интеграция с кафкой на получение актуальных ставок по депозитам;


### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Альтернативой стало бы допиливание партнерской системы до того состояния, когда она сможет по REST запросить текущие ставки из АБС.
На худой конец можно было бы научить ее ходить в S3 и публиковать файл в минио, а не отправлять по почте.
Но это потребует от партнеров доработки их ПО, что не факт что свершится.

**Недостатки, ограничения, риски**

* Файловый обмен между системами - одна из самых ужасных идей, что может прийти кому-либо в голову. Особенно если этот файл отправляют по почте.
* Используя посредник (почтовый сервис) мы получаем дополнительную точку отказа.
* Данные должны быть актуальными (деньги, как-никак). Использование эмейла добавляет ощутимый лаг к передаче данных партнеру.
* Используемая push-модель подразумевает постоянную нагрузку на АБС. С повышением скважности вычислений ради увеличения точности ставок нагрузка будет расти.
Этого можно избежать, если запрашивать данные только через API и вычислять из в момент первого запроса к кэшу. Впрочем, если ставки обновляются раз в сутки, то не страшно.

